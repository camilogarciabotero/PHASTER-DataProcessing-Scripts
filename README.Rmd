---
title: "Data procesing on PHASTER output dataset"
output: github_document
bibliography: packages.bib
#nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE,  comment= " ")
knitr::write_bib(c(.packages(), "knitr", "rmarkdown", "tidyverse"), "packages.bib")
```

This repo hosts the complete PHASTER dataset from the 59 strains' genomes analysed on PHASTER and several scripts developed for its processing. Analysis of this processed data is published on (paper). The primary packages used here are in the Tidyverse set of libraries, the rmarkdown and knitr packages were used to generate this report [@R-knitr; @R-rmarkdown; @tidyverse2019].

## Libraries

```{r libraries, include=T, warning=FALSE, message=FALSE}
library(tidyverse) 
library(magrittr)
library(readxl) 
library(rmarkdown)
library(knitr)
library(DT)
```


## Data importing and processing

The first step in this analysis is transforming the XSLSX file into a friendly data frame for R.

```{r Phaster-df, warning=FALSE}

df <- read_excel("Data/2020-09-14_PHASTER-raw.xlsx")
df %<>% mutate_at(vars(e_value), ~ as.numeric(as.character(.)))
df %<>% mutate_at(vars(species,completeness, genome), ~ as_factor(.))

glimpse(df)
```

## Fig 1C. Generating candiadate prophages organized by completeness (Incomplete, Questionable, Intact)

```{r prophage-candidates, message=FALSE}

by_completeness <- df %>%
  filter(hit_number == 1) %>% 
  group_by(species,genome) %>%
  summarise(
    Incomplete = sum(str_count(completeness, "Incomplete")),
    Questionable = sum(str_count(completeness, "Questionable")),
    Intact = sum(str_count(completeness, "Intact"))
  )

write_tsv(x = by_completeness, path = "Data/completeness_raw-01.tsv")

kable(by_completeness[1:5,])
```


## Fig 1D. Generating the total number of prophage proteins per bacteria species

```{r total-proteins, message=FALSE}

by_species_total <- df %>%
  group_by(species, genome) %>%
  summarise("Total prophage proteins" = sum(str_count(blast_hit, "PHAGE"))) %>% 
  summarize(
    across("Total prophage proteins", mean)
  )

write_tsv(x = by_species_total, path = "Data/total-proteins_raw-01.tsv")

kable(by_species_total[1:5,])
```

## Fig S1. Generating the dataset of the intact prophages in each bacterial species and vizualizing on a bubble-plot.

```{r intact_phages, message=FALSE}

intact_phages <- df %>%
  filter(completeness %in% c("Intact") & blast_hit %in% str_subset(blast_hit, "^PHAGE")) %>%
  mutate(Candidate = as.factor(str_extract(blast_hit, "[:graph:]+(?=:)")), region = as.factor(region)) %>%
  mutate(Candidate = str_remove(Candidate, "PHAGE_"),
         Candidate = str_replace(Candidate, "_", " "),
         Candidate = str_replace(Candidate, "Bacill", "Bacillus"),
         Candidate = str_replace(Candidate, "Brevib", "Brevibacillus"),
         Candidate = str_replace(Candidate, "Clostr", "Clostridium"),
         Candidate = str_replace(Candidate, "Thermu", "Thermus phi"),
         Candidate = str_replace(Candidate, "Paenib", "Paenibacillus"),
         Candidate = str_replace(Candidate, "Bacillus 1", "Bacillus virus 1"),
         Candidate = str_replace(Candidate, "Lister", "Listeria"),
         Candidate = str_replace(Candidate, "Geobac", "Geobacillus"),
         Candidate = str_replace(Candidate, "Staphy", "Staphylococcus"),
         ) %>%
  mutate(species = str_replace(species,"Bacillus", "B.")) %>% 
  separate(Candidate, c("Candidate", "Phage_NC_ID"), sep = "_NC_") %>%
  mutate(Candidate = str_remove(Candidate, "_")) %>% 
  select(species, score, region, Candidate, Phage_NC_ID) %>% 
  group_by(species, Candidate, region, score, Phage_NC_ID) %>% 
  summarise(
    CDS_hits = length(Candidate)
  ) %>% 
  group_by(species, region) %>% 
  filter(CDS_hits == max(CDS_hits)) %>% 
  mutate(Epithet = as_factor(word(species,2)))


write_tsv(x = intact_phages, path = "Data/intact-phages_raw-01.tsv")

kable(intact_phages[1:5,])
```

***

```{r bubble-plot, message=FALSE, fig.width=12, fig.height=15, dpi= 300, fig.align="center"}

intact_phages %>%
  as_tibble() %>%
  mutate(Species = species) %>%
  select(Species, Candidate, CDS_hits, Epithet) %>%
  pivot_wider(names_from = "Candidate", values_from = "CDS_hits", values_fill = 0, values_fn = sum) %>%
  pivot_longer(cols = -c(Species, Epithet), names_to = "Candidates", values_to = "CDS hits") %>%
  filter(`CDS hits` > 0) %>%
  ggplot(aes(Candidates, Species, size = `CDS hits`)) +
  geom_point() +
  facet_grid(rows = vars(Epithet), scales = "free", space = "free") +
  theme_bw() +
  scale_size_area(max_size = 8) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 14, face = "italic"),
    axis.text.y = element_text(size = 14, face = "italic"),
    axis.title.x = element_text(size = 17, face = "bold"),
    axis.title.y = element_text(size = 17, face = "bold"),
    strip.background = element_blank(),
    strip.text = element_blank(),
    legend.position = "right"
  ) +
  labs(
    x = "Prophage candidates",
    y = "Bacterial species"
  ) +
  ggsave("Figs/bubble-plot-02.pdf", width = 12, height = 15)

```

## License

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

## References

